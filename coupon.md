# 쿠폰 발급



준비 
로드밸런스 설정에서 여러 서버로 트래픽 분산을 준비합니다
- 쿠폰 발급을 처리 api 에 대해 전담 서버로 라우팅

또한 충분한 수의 인스턴스를 준비하여 오토 스케일링 그룹에 준비시킵니다
백엔드에서 rate limit을 설정하여 봇, 비정상 반복을 제한합니다
redis에 쿠폰 수량을 미리 저장합니다


정해진 쿠폰 수량을 레디스에 저장한다, 트래픽이 몰릴경우 대비하여 데이터를 분할하여 저장
> coupon_amount_0:{count}, coupon_amount_1:{count}
단일 키가 병목이 될수 있으므로 여러 샤드로 분할

사용자가 쿠폰 발급을 시작하면 쿠폰 발급 서비스에서는 lua script를 사용하여 
발급 가능한 상태인지 확인하고 쿠폰 수를 차감하고 쿠폰 발급 명단에 사용자를 추가한다

> 이미 발급 받앗는지, 쿠폰 수량이 충분한지 검사
> user_Id % n 으로 어떤 coupon_amount 를 사용할지 정한다
이후 카프카 메시지를 퍼블리싱하여 실제 쿠폰을 등록하는 작업을 진행하도록 한다
카프마 메시지는 user_id 등 식별자를 사용하여 멱등성을 유지한다 
